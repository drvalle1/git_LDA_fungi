ncomm=20
nburn=ngibbs/2
psi=0.01
gamma=0.1
res=LDA.abundance(y=y,ncomm=ncomm,ngibbs=ngibbs,nburn=nburn,psi=psi,gamma=gamma)
plot(res$llk,type='l')
seq1=250:nrow(res$theta)
theta=colMeans(res$theta[seq1,])
theta1=matrix(theta,nrow(y),ncomm)
boxplot(theta1)
rm(list=ls(all=TRUE))
set.seed(4)
nloc=1000
nspp=200
ncommun=5
base=floor(nloc/(ncommun-2))
#generate thetas
x=seq(from=-1,to=1,length.out=base)
y=sqrt(1-(x^2))*0.1
min1=0.0001
y[y<min1]=min1
# plot(x,y)
init=floor(nloc/ncommun)
seq1=c(seq(from=1,to=nloc,by=init),nloc)
theta=matrix(min1,nloc,ncommun)
for (i in 1:ncommun){
seq2=seq1[i]:(seq1[i]+base-1)
seq3=seq2[seq2<=nloc]
theta[seq3,i]=y[1:length(seq3)]
}
theta=theta/matrix(apply(theta,1,sum),nloc,ncommun)
theta.true=theta
plot(NA,NA,xlim=c(0,nloc),ylim=c(0,1))
for (i in 1:ncommun) lines(1:nloc,theta[,i],col=i)
#export theta
setwd('U:\\GIT_models\\git_LDA_fungi')
nome=paste('theta ',ncommun,'.csv',sep='')
write.csv(theta,nome,row.names=F)
#generate phi
phi=matrix(NA,ncommun,nspp)
mu.large=6
mu.small=2
ind=matrix(rbinom(ncommun*nspp,size=1,prob=0.1),ncommun,nspp)
for (i in 1:ncommun){
ind1=ind[i,]
cond=ind1==1
tmp=rep(NA,nspp)
tmp[cond ]=rnorm(sum( cond),mean=mu.large,sd=1)
tmp[!cond]=rnorm(sum(!cond),mean=mu.small,sd=1)
phi[i,]=tmp
}
image(phi)
phi.true=phi
#how many unique species does each community have?
teste=rep(0,ncommun)
for (i in 1:nspp){
tmp=ind[,i]
if (sum(tmp)==1){
ind1=which(tmp==1)
teste[ind1]=teste[ind1]+1
}
}
teste
medias=theta%*%phi; dim(medias)
z.true=z=matrix(rnorm(nloc*nspp,mean=medias,sd=1),nloc,nspp)
range(z)
break1.true=break1=c(-Inf,seq(from=0,to=6,by=0.1),Inf)
y=matrix(NA,nloc,nspp)
for (i in 2:length(break1)){
cond=z>break1[i-1] & z<break1[i]
y[cond]=i-2
}
tmp=table(y); tmp; length(tmp); length(break1)
nome=paste('fake data',ncommun,'.csv',sep='')
write.csv(y,nome,row.names=F)
rm(list=ls(all=TRUE))
set.seed(4)
library('Rcpp')
# library('MCMCpack')
setwd('U:\\GIT_models\\git_LDA_fungi')
source('gibbs LDA ordinal aux.R')
source('gibbs LDA ordinal function.R')
sourceCpp('LDA_ordinal_rcpp.cpp')
dat=data.matrix(read.csv('fake data5.csv',as.is=T))
ngibbs=1000
ncomm.max=20
prop.burn=0.9
gamma=1
res=LDA_ordinal(dat=dat,ncomm.max=ncomm.max,ngibbs=ngibbs,prop.burn=prop.burn,gamma=gamma)
nloc=nrow(dat)
nspp=ncol(dat)
#look at logl
seq1=(ngibbs*0.2):ngibbs
plot(res$logl[seq1],type='l')
#look at theta
theta.estim=matrix(colMeans(res$theta),nloc,ncomm.max)
boxplot(theta.estim)
#black, red, green, blue, cyan
seq.comm=1:ncomm.max
# seq.comm=c(3,1,5,2,4)
theta.estim1=theta.estim[,seq.comm]
plot(NA,NA,xlim=c(0,nloc),ylim=c(0,1))
for (i in 1:ncomm.max){
lines(1:nloc,theta.estim1[,i],col=i)
}
phi.estim=matrix(colMeans(res$phi),ncomm.max,nspp)[seq.comm,]
rango=range(phi.estim,phi.true)
plot(phi.true,phi.estim,ylim=rango,xlim=rango)
lines(rango,rango)
seq.comm=1:ncomm.max
# seq.comm=c(3,1,5,2,4)
theta.estim1=theta.estim[,seq.comm]
plot(NA,NA,xlim=c(0,nloc),ylim=c(0,1))
for (i in 1:ncomm.max){
lines(1:nloc,theta.estim1[,i],col=i)
}
set.seed(4)
nloc=1000
nspp=200
ncommun=5
base=floor(nloc/(ncommun-2))
#generate thetas
x=seq(from=-1,to=1,length.out=base)
y=sqrt(1-(x^2))*0.1
min1=0.0001
y[y<min1]=min1
# plot(x,y)
init=floor(nloc/ncommun)
seq1=c(seq(from=1,to=nloc,by=init),nloc)
theta=matrix(min1,nloc,ncommun)
for (i in 1:ncommun){
seq2=seq1[i]:(seq1[i]+base-1)
seq3=seq2[seq2<=nloc]
theta[seq3,i]=y[1:length(seq3)]
}
theta=theta/matrix(apply(theta,1,sum),nloc,ncommun)
theta.true=theta
plot(NA,NA,xlim=c(0,nloc),ylim=c(0,1))
for (i in 1:ncommun) lines(1:nloc,theta[,i],col=i)
#export theta
setwd('U:\\GIT_models\\git_LDA_fungi')
nome=paste('theta ',ncommun,'.csv',sep='')
write.csv(theta,nome,row.names=F)
#generate phi
phi=matrix(NA,ncommun,nspp)
mu.large=6
mu.small=2
ind=matrix(rbinom(ncommun*nspp,size=1,prob=0.1),ncommun,nspp)
for (i in 1:ncommun){
ind1=ind[i,]
cond=ind1==1
tmp=rep(NA,nspp)
tmp[cond ]=rnorm(sum( cond),mean=mu.large,sd=1)
tmp[!cond]=rnorm(sum(!cond),mean=mu.small,sd=1)
phi[i,]=tmp
}
image(phi)
phi.true=phi
#how many unique species does each community have?
teste=rep(0,ncommun)
for (i in 1:nspp){
tmp=ind[,i]
if (sum(tmp)==1){
ind1=which(tmp==1)
teste[ind1]=teste[ind1]+1
}
}
#calculate probabilities
medias=theta%*%phi; dim(medias)
z.true=z=matrix(rnorm(nloc*nspp,mean=medias,sd=1),nloc,nspp)
#generate actual observations y
range(z)
break1.true=break1=c(-Inf,seq(from=0,to=6,by=0.1),Inf)
y=matrix(NA,nloc,nspp)
for (i in 2:length(break1)){
cond=z>break1[i-1] & z<break1[i]
y[cond]=i-2
}
tmp=table(y); tmp; length(tmp); length(break1)
seq.comm=1:ncomm.max
# seq.comm=c(3,1,5,2,4)
theta.estim1=theta.estim[,seq.comm]
plot(NA,NA,xlim=c(0,nloc),ylim=c(0,1))
for (i in 1:ncomm.max){
lines(1:nloc,theta.estim1[,i],col=i)
}
#look at phi
phi.estim=matrix(colMeans(res$phi),ncomm.max,nspp)[seq.comm,]
rango=range(phi.estim,phi.true)
plot(phi.true,phi.estim,ylim=rango,xlim=rango)
lines(rango,rango)
ncomm.max
ncomm.max=5
seq.comm=1:ncomm.max
# seq.comm=c(3,1,5,2,4)
theta.estim1=theta.estim[,seq.comm]
plot(NA,NA,xlim=c(0,nloc),ylim=c(0,1))
for (i in 1:ncomm.max){
lines(1:nloc,theta.estim1[,i],col=i)
}
phi.estim=matrix(colMeans(res$phi),ncomm.max,nspp)[seq.comm,]
rango=range(phi.estim,phi.true)
plot(phi.true,phi.estim,ylim=rango,xlim=rango)
lines(rango,rango)
#look at breaks
break2=break1.true[-c(1,length(break1.true))]
break.estim=colMeans(res$break1)
rango=range(break.estim,break2)
plot(break2,break.estim,xlim=rango,ylim=rango)
lines(rango,rango)
phi.estim=matrix(colMeans(res$phi),ncomm.max,nspp)[seq.comm,]
rango=range(phi.estim,phi.true)
plot(phi.true,phi.estim,ylim=rango,xlim=rango)
lines(rango,rango)
ncomm.max=20
phi.estim=matrix(colMeans(res$phi),ncomm.max,nspp)[seq.comm,]
rango=range(phi.estim,phi.true)
plot(phi.true,phi.estim,ylim=rango,xlim=rango)
lines(rango,rango)
seq.comm
phi.estim=matrix(colMeans(res$phi),ncomm.max,nspp)[seq.comm,]
rango=range(phi.estim,phi.true)
plot(phi.true,phi.estim,ylim=rango,xlim=rango)
lines(rango,rango)
break2=break1.true[-c(1,length(break1.true))]
break.estim=colMeans(res$break1)
